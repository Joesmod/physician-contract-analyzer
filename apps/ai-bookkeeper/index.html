<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Bookkeeper</title>
<link rel="stylesheet" href="style.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="cta-banner">Need help automating your finances? <a href="https://nexusai.dev" target="_blank">Visit nexusai.dev ‚Üí</a></div>

<div class="container">
<header>
  <h1><span>üìä</span> AI Bookkeeper</h1>
  <p>Smart transaction tracking with auto-categorization</p>
</header>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
  <div class="card stat income"><div class="value" id="totalIncome">$0</div><div class="label">Total Income</div></div>
  <div class="card stat expense"><div class="value" id="totalExpense">$0</div><div class="label">Total Expenses</div></div>
  <div class="card stat net"><div class="value" id="netProfit">$0</div><div class="label">Net Profit/Loss</div></div>
  <div class="card stat margin"><div class="value" id="profitMargin">0%</div><div class="label">Profit Margin</div></div>
</div>

<!-- Add Transaction -->
<div class="card" style="margin-bottom:24px">
  <h2>Add Transaction</h2>
  <div class="form-grid">
    <div class="form-group"><label>Date</label><input type="date" id="txDate"></div>
    <div class="form-group"><label>Description</label><input type="text" id="txDesc" placeholder="e.g. AWS Monthly"></div>
    <div class="form-group"><label>Amount ($)</label><input type="number" id="txAmount" step="0.01" min="0" placeholder="0.00"></div>
    <div class="form-group"><label>Type</label><select id="txType"><option value="expense">Expense</option><option value="income">Income</option></select></div>
    <div class="form-group"><label>Category</label><select id="txCategory">
      <option value="auto">Auto-detect</option>
      <option value="Rent">Rent</option><option value="Utilities">Utilities</option><option value="Payroll">Payroll</option>
      <option value="Marketing">Marketing</option><option value="Software/SaaS">Software/SaaS</option><option value="Travel">Travel</option>
      <option value="Office Supplies">Office Supplies</option><option value="Professional Services">Professional Services</option>
      <option value="Insurance">Insurance</option><option value="Meals">Meals</option><option value="Other">Other</option>
    </select></div>
    <div class="form-group"><label>&nbsp;</label><button class="btn btn-primary" onclick="addTransaction()" style="width:100%">+ Add</button></div>
  </div>
</div>

<!-- OpenAI Toggle -->
<div class="card" style="margin-bottom:24px">
  <h2>AI Categorization</h2>
  <div class="toggle-row">
    <label class="toggle"><input type="checkbox" id="openaiToggle" onchange="toggleOpenAI()"><span class="slider"></span></label>
    <span>Use OpenAI for smarter categorization</span>
  </div>
  <div class="openai-config" id="openaiConfig">
    <input type="password" id="openaiKey" placeholder="Enter OpenAI API key" onchange="saveOpenAIKey()">
    <p style="font-size:.75rem;color:var(--text2);margin-top:6px">Key stored in localStorage only. Never sent anywhere except OpenAI.</p>
  </div>
</div>

<!-- Filters -->
<div class="controls">
  <select id="filterMonth" onchange="render()"><option value="all">All Months</option></select>
  <select id="filterCategory" onchange="render()">
    <option value="all">All Categories</option>
    <option value="Rent">Rent</option><option value="Utilities">Utilities</option><option value="Payroll">Payroll</option>
    <option value="Marketing">Marketing</option><option value="Software/SaaS">Software/SaaS</option><option value="Travel">Travel</option>
    <option value="Office Supplies">Office Supplies</option><option value="Professional Services">Professional Services</option>
    <option value="Insurance">Insurance</option><option value="Meals">Meals</option><option value="Other">Other</option>
  </select>
  <select id="filterType" onchange="render()"><option value="all">All Types</option><option value="income">Income</option><option value="expense">Expense</option></select>
  <button class="btn btn-secondary" onclick="showCSVImport()">üì• CSV Import</button>
  <button class="btn btn-secondary" onclick="exportCSV()">üì§ CSV Export</button>
</div>

<!-- Charts -->
<div class="sections">
  <div class="card"><h2>Monthly Breakdown</h2><div id="monthlyChart" class="bar-chart"></div></div>
  <div class="card"><h2>Category Breakdown</h2><div id="categoryChart"></div></div>
</div>

<!-- Transactions Table -->
<div class="card" style="margin-bottom:40px">
  <h2>Transactions</h2>
  <div class="table-wrap">
    <table>
      <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th>Amount</th><th>Actions</th></tr></thead>
      <tbody id="txBody"></tbody>
    </table>
  </div>
  <div class="empty" id="emptyState" style="display:none"><span>üì≠</span>No transactions yet. Add one above!</div>
</div>
</div>

<!-- CSV Import Modal -->
<div class="modal-overlay" id="csvModal">
  <div class="modal">
    <h3>üì• CSV Import</h3>
    <p style="font-size:.8rem;color:var(--text2);margin-bottom:12px">Paste CSV data: <code>date,description,amount</code> (negative = expense, positive = income)</p>
    <textarea class="csv-area" id="csvData" placeholder="2024-01-15,AWS Monthly,‚àí149.99&#10;2024-01-16,Client Payment,5000&#10;2024-01-17,Uber to Airport,-42.50"></textarea>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-secondary" onclick="closeCSVModal()">Cancel</button>
      <button class="btn btn-primary" onclick="importCSV()">Import</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h3>‚úèÔ∏è Edit Transaction</h3>
    <input type="hidden" id="editId">
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="form-group"><label>Date</label><input type="date" id="editDate"></div>
      <div class="form-group"><label>Description</label><input type="text" id="editDesc"></div>
      <div class="form-group"><label>Amount</label><input type="number" id="editAmount" step="0.01" min="0"></div>
      <div class="form-group"><label>Type</label><select id="editType"><option value="expense">Expense</option><option value="income">Income</option></select></div>
      <div class="form-group"><label>Category</label><select id="editCategory">
        <option value="Rent">Rent</option><option value="Utilities">Utilities</option><option value="Payroll">Payroll</option>
        <option value="Marketing">Marketing</option><option value="Software/SaaS">Software/SaaS</option><option value="Travel">Travel</option>
        <option value="Office Supplies">Office Supplies</option><option value="Professional Services">Professional Services</option>
        <option value="Insurance">Insurance</option><option value="Meals">Meals</option><option value="Other">Other</option>
      </select></div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
      <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = 'ai_bookkeeper_tx';
const OPENAI_KEY_STORE = 'ai_bookkeeper_openai_key';
const OPENAI_TOGGLE_STORE = 'ai_bookkeeper_openai_on';

const KEYWORDS = {
  'Rent': ['rent','lease','landlord','property'],
  'Utilities': ['electric','water','gas','internet','phone','comcast','verizon','att','t-mobile','utility','power','sewage'],
  'Payroll': ['payroll','salary','wage','bonus','contractor pay','employee'],
  'Marketing': ['ads','advertising','facebook ads','google ads','meta ads','campaign','seo','marketing','hubspot','mailchimp','semrush'],
  'Software/SaaS': ['aws','azure','gcp','google cloud','heroku','vercel','netlify','github','gitlab','slack','notion','figma','adobe','microsoft 365','office 365','dropbox','zoom','saas','software','subscription','openai','chatgpt','stripe fee','shopify'],
  'Travel': ['uber','lyft','airline','flight','hotel','airbnb','taxi','car rental','hertz','avis','travel','amtrak','delta','united','southwest','jetblue'],
  'Office Supplies': ['staples','office depot','amazon office','paper','printer','ink','toner','supplies','desk','chair','monitor'],
  'Professional Services': ['lawyer','attorney','legal','accountant','accounting','cpa','consultant','consulting','audit','bookkeep'],
  'Insurance': ['insurance','policy','premium','geico','state farm','allstate','liability','coverage'],
  'Meals': ['restaurant','lunch','dinner','breakfast','coffee','starbucks','doordash','grubhub','ubereats','meal','food','catering','chipotle','mcdonalds','panera']
};

let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions)); }

function categorize(desc) {
  const d = desc.toLowerCase();
  for (const [cat, keys] of Object.entries(KEYWORDS)) {
    if (keys.some(k => d.includes(k))) return cat;
  }
  return 'Other';
}

async function categorizeAI(desc) {
  const key = localStorage.getItem(OPENAI_KEY_STORE);
  const on = localStorage.getItem(OPENAI_TOGGLE_STORE) === 'true';
  if (!on || !key) return categorize(desc);
  try {
    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body: JSON.stringify({model:'gpt-3.5-turbo',messages:[{role:'system',content:'Categorize this expense into exactly one: Rent, Utilities, Payroll, Marketing, Software/SaaS, Travel, Office Supplies, Professional Services, Insurance, Meals, Other. Reply with only the category name.'},{role:'user',content:desc}],max_tokens:20})
    });
    const data = await r.json();
    const cat = data.choices?.[0]?.message?.content?.trim();
    const valid = Object.keys(KEYWORDS).concat(['Other']);
    return valid.includes(cat) ? cat : categorize(desc);
  } catch { return categorize(desc); }
}

function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

function fmt(n) { return '$' + Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

async function addTransaction() {
  const date = document.getElementById('txDate').value;
  const desc = document.getElementById('txDesc').value.trim();
  const amount = parseFloat(document.getElementById('txAmount').value);
  const type = document.getElementById('txType').value;
  const catSel = document.getElementById('txCategory').value;

  if (!date || !desc || isNaN(amount) || amount <= 0) return alert('Please fill all fields correctly.');

  let category = catSel === 'auto' ? await categorizeAI(desc) : catSel;
  if (type === 'income') category = 'Income';

  transactions.push({id:genId(), date, desc, amount, type, category});
  save(); render();

  document.getElementById('txDesc').value = '';
  document.getElementById('txAmount').value = '';
}

function deleteTx(id) {
  if (!confirm('Delete this transaction?')) return;
  transactions = transactions.filter(t => t.id !== id);
  save(); render();
}

function editTx(id) {
  const t = transactions.find(x => x.id === id); if (!t) return;
  document.getElementById('editId').value = id;
  document.getElementById('editDate').value = t.date;
  document.getElementById('editDesc').value = t.desc;
  document.getElementById('editAmount').value = t.amount;
  document.getElementById('editType').value = t.type;
  document.getElementById('editCategory').value = t.type === 'income' ? 'Other' : t.category;
  document.getElementById('editModal').classList.add('show');
}

function closeEditModal() { document.getElementById('editModal').classList.remove('show'); }

function saveEdit() {
  const id = document.getElementById('editId').value;
  const t = transactions.find(x => x.id === id); if (!t) return;
  t.date = document.getElementById('editDate').value;
  t.desc = document.getElementById('editDesc').value;
  t.amount = parseFloat(document.getElementById('editAmount').value);
  t.type = document.getElementById('editType').value;
  t.category = t.type === 'income' ? 'Income' : document.getElementById('editCategory').value;
  save(); render(); closeEditModal();
}

function showCSVImport() { document.getElementById('csvModal').classList.add('show'); }
function closeCSVModal() { document.getElementById('csvModal').classList.remove('show'); }

async function importCSV() {
  const raw = document.getElementById('csvData').value.trim();
  if (!raw) return;
  const lines = raw.split('\n').filter(l => l.trim());
  let count = 0;
  for (const line of lines) {
    const parts = line.split(',');
    if (parts.length < 3) continue;
    const date = parts[0].trim();
    const desc = parts.slice(1, -1).join(',').trim();
    let amount = parseFloat(parts[parts.length-1].trim().replace(/[‚àí‚Äì]/g,'-'));
    if (isNaN(amount)) continue;
    const type = amount < 0 ? 'expense' : 'income';
    amount = Math.abs(amount);
    const category = type === 'income' ? 'Income' : await categorizeAI(desc);
    transactions.push({id:genId(), date, desc, amount, type, category});
    count++;
  }
  save(); render(); closeCSVModal();
  document.getElementById('csvData').value = '';
  alert(`Imported ${count} transactions.`);
}

function exportCSV() {
  if (!transactions.length) return alert('No transactions to export.');
  let csv = 'Date,Description,Amount,Type,Category\n';
  for (const t of transactions) {
    const a = t.type === 'expense' ? -t.amount : t.amount;
    csv += `${t.date},"${t.desc.replace(/"/g,'""')}",${a},${t.type},${t.category}\n`;
  }
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bookkeeper_export.csv';
  a.click();
}

function toggleOpenAI() {
  const on = document.getElementById('openaiToggle').checked;
  localStorage.setItem(OPENAI_TOGGLE_STORE, on);
  document.getElementById('openaiConfig').classList.toggle('show', on);
}

function saveOpenAIKey() {
  localStorage.setItem(OPENAI_KEY_STORE, document.getElementById('openaiKey').value);
}

function getFiltered() {
  const m = document.getElementById('filterMonth').value;
  const c = document.getElementById('filterCategory').value;
  const t = document.getElementById('filterType').value;
  return transactions.filter(tx => {
    if (m !== 'all' && !tx.date.startsWith(m)) return false;
    if (c !== 'all' && tx.category !== c) return false;
    if (t !== 'all' && tx.type !== t) return false;
    return true;
  });
}

function render() {
  const filtered = getFiltered();

  // Dashboard
  const income = filtered.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = filtered.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const net = income - expense;
  const margin = income > 0 ? (net/income*100) : 0;
  document.getElementById('totalIncome').textContent = fmt(income);
  document.getElementById('totalExpense').textContent = fmt(expense);
  const netEl = document.getElementById('netProfit');
  netEl.textContent = (net < 0 ? '-' : '') + fmt(net);
  netEl.className = 'value ' + (net >= 0 ? 'positive' : 'negative');
  document.getElementById('profitMargin').textContent = margin.toFixed(1) + '%';

  // Month filter options
  const months = [...new Set(transactions.map(t => t.date.slice(0,7)))].sort().reverse();
  const mSel = document.getElementById('filterMonth');
  const curM = mSel.value;
  mSel.innerHTML = '<option value="all">All Months</option>' + months.map(m => `<option value="${m}">${m}</option>`).join('');
  mSel.value = curM;

  // Monthly chart
  const monthData = {};
  filtered.forEach(t => {
    const m = t.date.slice(0,7);
    if (!monthData[m]) monthData[m] = {income:0,expense:0};
    monthData[m][t.type] += t.amount;
  });
  const sortedMonths = Object.keys(monthData).sort();
  const maxMonth = Math.max(...sortedMonths.flatMap(m => [monthData[m].income, monthData[m].expense]), 1);
  document.getElementById('monthlyChart').innerHTML = sortedMonths.length ? sortedMonths.map(m => `
    <div class="bar-row"><span class="bar-label">${m}</span><div class="bar-track"><div class="bar-fill income" style="width:${monthData[m].income/maxMonth*100}%"></div></div><span class="bar-value" style="color:var(--green)">${fmt(monthData[m].income)}</span></div>
    <div class="bar-row"><span class="bar-label"></span><div class="bar-track"><div class="bar-fill expense" style="width:${monthData[m].expense/maxMonth*100}%"></div></div><span class="bar-value" style="color:var(--red)">${fmt(monthData[m].expense)}</span></div>
  `).join('') : '<div class="empty"><span>üìä</span>No data</div>';

  // Category chart
  const catData = {};
  filtered.filter(t=>t.type==='expense').forEach(t => { catData[t.category] = (catData[t.category]||0) + t.amount; });
  const catTotal = Object.values(catData).reduce((s,v)=>s+v, 0) || 1;
  const maxCat = Math.max(...Object.values(catData), 1);
  const sortedCats = Object.entries(catData).sort((a,b) => b[1]-a[1]);
  document.getElementById('categoryChart').innerHTML = sortedCats.length ? sortedCats.map(([name,amt]) => `
    <div class="cat-row"><span class="cat-name">${name}</span><div class="cat-track"><div class="cat-fill" style="width:${amt/maxCat*100}%"></div></div><span class="cat-pct">${(amt/catTotal*100).toFixed(1)}%</span><span class="cat-amt">${fmt(amt)}</span></div>
  `).join('') : '<div class="empty"><span>üìÇ</span>No expenses</div>';

  // Table
  const sorted = [...filtered].sort((a,b) => b.date.localeCompare(a.date));
  const tbody = document.getElementById('txBody');
  const empty = document.getElementById('emptyState');
  if (!sorted.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = sorted.map(t => `<tr>
    <td>${t.date}</td><td>${t.desc}</td><td>${t.category}</td>
    <td class="type-${t.type}">${t.type === 'income' ? '‚Üë Income' : '‚Üì Expense'}</td>
    <td class="type-${t.type}">${t.type==='expense'?'-':''}${fmt(t.amount)}</td>
    <td><div class="actions-cell"><button class="btn btn-secondary btn-sm" onclick="editTx('${t.id}')">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="deleteTx('${t.id}')">üóë</button></div></td>
  </tr>`).join('');
}

// Init
document.getElementById('txDate').valueAsDate = new Date();
const oaiOn = localStorage.getItem(OPENAI_TOGGLE_STORE) === 'true';
document.getElementById('openaiToggle').checked = oaiOn;
if (oaiOn) document.getElementById('openaiConfig').classList.add('show');
document.getElementById('openaiKey').value = localStorage.getItem(OPENAI_KEY_STORE) || '';
render();
</script>
</body>
</html>
